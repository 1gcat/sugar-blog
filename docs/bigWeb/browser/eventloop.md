---
isTimeLine: true
title: 浏览器-事件循环机制
date: 2021-01-19
tags:
 - 大前端
 - 浏览器
categories:
 - 大前端
---
# 浏览器中的Event loop
## 前言
先简单聊聊JavaScript与此主题有关的其它内容，加深读者对内容的吸收与理解

### 解释性语言
>脚本语言是为了缩短传统的编写-编译-链接-运行（edit-compile-link-run）过程而创建的计算机编程语言

**脚本语言**编写的代码通常是**逐行解释执行**而非编译（c/c++,java），所以通常又叫做**解释性语言**

所以`javascript`与`python`,`shell`一样，也是一门优秀的解释性语言

制约解释性语言的性能瓶颈之一就是解释器，好在`javascript`有著名的V8（Android，Chrome）与JSCore（IOS，Safari）等优秀的解释器引擎,js得以大范围推广，它们是必不可少的功臣

### 单线程模型
`javascript`语言的一大特点就是单线程，即同一时间只能做一件事

**为什么是单线程？**

作为浏览器脚本语言，`javascript`的主要用途是与用户互动，以及操作DOM,这决定了它只能是单线程，否则会带来很复杂的同步问题

例如：假定`javascript`同时有两个线程，一个线程在某个DOM节点上添加内容，另一个线程删除了这个节点，这时浏览器不知道应该以哪个线程为准？

所以，为了避免复杂性，从一诞生，`javascript`就是单线程的

**单线程的优势**
* 不会出现因线程之间争夺资源导致的死锁现象
* 所有代码都是同步执行的
* 没有线程切换的资源开销

**单线程的缺点**
* 单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着

### 任务队列
浏览器中存在有很多耗时的任务的场景，网路请求(ajax),监听事件的传递,定时器等等

`javascript`语言的设计者意识到，这时主线程完全可以不管IO设备，挂起处于等待中的任务，先运行排在后面的任务。等到IO设备返回了结果，再回过头，把挂起的任务继续执行下去

于是对所有任务进行了划分，分为 **同步任务** 与 **异步任务**

#### 同步任务
在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务

即顺序执行

#### 异步任务
不进入主线程、而进入**任务队列**的任务

只有当**任务队列**通知主线程，某个异步任务可以执行了的时候，该任务才会进入主线程执行

打个比方，就像炒菜一样，锅里的东西一直在翻炒着(主线程)，各种调料（不同的异步任务）只会在需要的时候被加入锅里，然后完成其使命

### 异步机制

1. 所有同步任务都在主线程上执行，形成一个**执行栈**
2. 主线程之外，还存在一个**任务队列**，只要异步任务有了运行结果，就在"任务队列"之中放置一个事件
3. 一旦执行栈中的所有同步任务执行完毕，系统就会读取"任务队列"，看看里面有哪些事件。哪些对应的异步任务，于是结束等待状态，进入执行栈，开始执行

只要主线程空了，就会去读取"任务队列"，这就是`javascript`的运行机制。主线程不断重复上面的第3步

### 事件与回调
"任务队列"是一个事件的队列，IO设备（鼠标，键盘等）完成一项任务，就在"任务队列"中添加一个事件，表示相关的异步任务可以进入"执行栈"了。主线程读取"任务队列"，就是读取里面有哪些事件

只要指定过**回调函数**，这些事件（鼠标点击，键盘按键，页面滚动等）发生时就会进入"任务队列"，等待主线程读取

所谓"回调函数"，就是那些会被主线程挂起来的代码。异步任务必须指定回调函数，当主线程开始执行异步任务，就是执行对应的回调函数

队列有先进先出的特性，主线程会优先读取任务队列最前面的事件

主线程的读取过程基本上是自动的，只要”执行栈“一清空，"任务队列"上第1位的事件就会自动进入主线程

针对于定时器事件，主线程会先检查一下执行时间，只有到了规定的时间，才能返回给主线程，即到了一定时间后才把事件对应的回调函数放入执行栈中

## Event loop
### 什么是Event Loop
也就是通常说的事件循环

>Event Loop是一个**执行模型**，在不同的地方(不同的语言)有不同的实现

js的事件循环负责执行代码、收集和处理事件以及执行队列中的子任务，与其它语言的模型截然不同

js的事件循环模型与许多其他语言相比有一个非常有趣的特性是，它**永不阻塞**,处理 I/O 通常通过事件和回调来执行

因此当一个应用正等待一个 AJAX 请求返回时，它仍然可以处理其它事情，如用户输入，鼠标点击/滚动等

### 什么是执行栈
执行栈可以认为是一个存储函数调用的``栈结构``，遵循先进后出的原则

js开始执行代码的时候会首先创建一个``main``函数,然后根据执行的代码,根据先进后出的原则,后执行的函数先弹出栈

示例
```js
function a(v){
    return v*4
}
function b(v){
    return a(v*3)
}
console.log(b(2))
```
进栈顺序
```js
1. main()
2. console.log(b(2))
3. b(2)
4. a(6)
```
出栈顺序
```js
1. a(6)  // 24
2. b(2)  // 24
3. console.log(b(2)) // 24
4. main()
```

使用递归的时候，因为栈可存放的函数是有限制的，一旦存放了过多的函数且没有得到释放的话，就会出现爆栈

![图片](https://img.cdn.sugarat.top/mdImg/MTYxMTA2ODQxNTc5OQ==611068415799)


## 浏览器中的 Event Loop
...wait 预计明天整理完成

## 参考
* [阮一峰：JavaScript 运行机制详解：再谈Event Loop](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)
* [MDN：并发模型与事件循环 ](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop)

<comment/>
<tongji/>